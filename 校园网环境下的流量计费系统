b;jiotsesaDzCX1 问题 ：
某 校 园 网 需 要 在 出 口 处 部 署 流 量 计 费 系 统 ， 统 计上 网 使 用 的 累 计 流 量 进 行 计 费 。 学 校 出 口 带 宽 100M，平 均 每 秒通 过 计 费 系 统 的 数 据 包 个 数 约 为 100000 个 ，统 计 方 式 为 获 取 每个 数 据 包 的 IP 地 址 和 包 大 小 ， 将 包 大 小 值 累 加 到 该 IP 对应 的10000 个 以 内 。 要 求 设 计 一 个 合 理 的 算 法 来 快 速 统 计 流 量 。

2 分 析 ：
每 秒 通 过 计 费 系 统 的 数 据 包 个 数 为 100000 个 ， 校 园 网 IP地 址 数 10000 个 ，如 果 使 用 传 统 的 线 性 表 来 存 储 每 个 IP 的 流 量数 ， 在对线 性 表 根 据 IP 信 息 进 行 过 排 序 之 后 ， 最 佳 情 况 是 使 用折半查找 ，其时 间 复 杂 度 为 O(log2n)，n=10000 时 平 均 每 个 数 据 包需 要 花 费 13 次 比 较 。 在 实 际 应 用 中 每 秒 钟 平 均 需 要 进 行1300000 次 的 比 较 操 作 才 能 够 将 流 量 信 息 记 录 到 各 个 IP 对 应 的数据结构中 。 且每次新增加Ip地址后 ，还 需 要 进 行 重 新 排 序 ，其运 算 量 更 为 巨 大 。 因 此 ，我 们 需 要 对 此 进 行 改 进 和 优 化 。

3 优 化 处 理 ：
优化的目标 ：
• 新 增 IP 不 需 要 进 行 排 序 。
• 达 到 O(1)的 检 索 性 能 。
根 据 优 化 目 标 ， 我 们 采 用 HasH 表 来 进 行 存 储 ， 根 据 上 文HASH 查 找 的 性 能 分 析 中 可 知 ，为 了 提 升 查 找 性 能 ，可 以 适 当 增加 表 空 间 ， 降 低 散 列 表 的 装 填 因 子 ， 合 理 设 计 散 列 函 数 ， 使 散 列函 数 尽 可 能 均 匀 ，并 选 用 合 适 的 冲 突 处 理 方 法 。

1. 确 定 HasH 地 址 空 间 ：IP 地 址 的 显 示 格 式 为 XXX.XXX.XXX.XXX，而 在 网 络 数 据 包 中 ，IP 地 址 是 以 一 个 32 位 无 符 号 整形 数 存 储 的 ， 其 共 有 4294967296 种 可 能 ， 考 虑 到 校 园 网 内 的 IP数 量 不 超 过 10000 个 ， 为 了 快 速 地 进 行 HasH 运 算 ， 并 通 过 适 当提 高 散 列 值 地 址 范 围 来 减 少 上 列 表 的 装 填 因 子 ，可 以 将 HasH 后的 散 列 值 定 为 16 位 ，即 将 IP 地 址 进 行 HasH 运 算 后 的 散 列 值 分布 在 0～65535 之 间 。

2. 确 定 表 空 间 ： 由 于 校 园 网 内 IP 数 在 10000 以 内 ，IP 地 址散 列 值 为 16 位 ，则 表 空 间 大 小 为 65536 项 。

3.确 定 冲 突 处 理 方 式 ：使 用 链 地 址 法 进 行 冲 突 处 理 ，即 每 个表 项 为 动 态 链 表 ， 无 冲 突 时 只 有 一 个 项 ， 当 发 生 冲 突 时 ， 动 态 为
这个散列值地址对应的表项增加一个子项 。

4. 确 定 HasH 函 数 ：为 了 将 4 个 字 节 的 IP 地 址 信 息 HasH 到2 个 字 节 的 地 址 空 间 中 ， 同 时 达 到 HasH 函 数 要 求 的 简 单 易 用采 用 折 叠 法 和 除 留 余 数 法 相 结 合 来 进 行 IP 地 址 信 息 的 HasH 运算 。
int HasH(u_cHar *key)
{
unsigned long H=0;
H = (key[0]+key[2])*256+key[1]+key[3];

return H%65536;
}

